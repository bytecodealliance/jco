<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>jco</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-5bfb50bc.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-69241bbd.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">jco</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/bytecodealliance/jco" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><code>jco</code> is a fully native tool for working with <a href="https://component-model.bytecodealliance.org/design/components.html">WebAssembly Components</a> in JavaScript.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li><a href="#transpiling">Transpiling</a> Wasm Component binaries into <a href="https://nodejs.org/api/esm.html#modules-ecmascript-modules">ECMAScript modules</a> that can run in any JavaScript environment.</li>
<li>WASI Preview2 support in Node.js &amp; browsers (experimental).</li>
<li>Component builds of Wasm Tools helpers, available for use as a library or CLI commands for use in native JS environments</li>
<li>Optimization helper for Components via Binaryen.</li>
<li><code>componentize</code> command to easily create components written in JavaScript (wrapper of <a href="https://github.com/bytecodealliance/ComponentizeJS">ComponentizeJS</a>).</li>
</ul>
<blockquote>
<p>Note: This is an experimental project. <strong>No guarantees</strong> are provided for stability, security or support and breaking changes may be made without notice.</p>
</blockquote>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>To contribute to the codebase of the project, refer to the <a href="#contributing-to-the-codebase">Contributor guide</a>.</p>
<p>To contribute to the documentation, refer to the <a href="#contributing-to-docs">Contributor guide</a>.</p>
<p>If you find a mistake, omission, ambiguity, or other problem, please let us know via <a href="https://github.com/bytecodealliance/jco/issues">GitHub issues</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="transpiling"><a class="header" href="#transpiling">Transpiling</a></h1>
<p>Components can be transpiled in two separate modes:</p>
<ul>
<li>ESM Integration (default)</li>
<li><a href="#instantiation">Instantiation</a> - async or sync</li>
</ul>
<p>When using the default direct ESM transpilation mode, the output file is a JavaScript module, which imports the component imports,
and exports the component exports.</p>
<p><a href="#instantiation">Instantiation mode</a> allows dynamically providing the imports for the component instantiation, as well as for instantiating a component multiple times.</p>
<p>For the default output, you will likely want to ensure there is a package.json file with a <code>{ "type": "module" }</code> set for Node.js ES module support (although this is not needed for browser module loading or JS build tooling).</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>To transpile a component into JS:</p>
<pre><code>jco transpile component.wasm -o out-dir
</code></pre>
<p>The resultant file can be imported providing the bindings of the component as if it were imported directly:</p>
<p>app.js</p>
<pre><code>import { fn } from './out-dir/component.js';

fn();
</code></pre>
<p>Imports can be remapped using the <code>--map</code> flag, or to provide imports as an argument use the <code>--instantiation</code> option.</p>
<p>Components relying on WASI bindings will contain external WASI imports, which are automatically updated
to the <code>@bytecodealliance/preview2-shim</code> package. This package can be installed from npm separately for
runtime usage. This shim layer supports both Node.js and browsers.</p>
<h2 id="options"><a class="header" href="#options">Options</a></h2>
<p>Options include:</p>
<ul>
<li>
<p><code>--name</code>: Give a custom name for the component JS file in <code>out-dir/[name].js</code></p>
</li>
<li>
<p><code>--minify</code>: Minify the component JS</p>
</li>
<li>
<p><code>--optimize</code>: Runs the internal core Wasm files through Binaryen for optimization. Optimization options can be passed with a <code>-- &lt;binaryen options&gt;</code> flag separator.</p>
</li>
<li>
<p><code>--tla-compat</code>: Instead of relying on top-level-await, requires an <code>$init</code> promise to be imported and awaited first.</p>
</li>
<li>
<p><code>--js</code>: Converts core Wasm files to JavaScript for environments that don’t even support core Wasm.</p>
</li>
<li>
<p><code>--base64-cutoff=&lt;number&gt;</code>: Sets the maximum number of bytes for inlining Wasm files into the JS using base64 encoding. Set to zero to disable base64 inlining entirely.</p>
</li>
<li>
<p><code>--no-wasi-shim</code>: Disable the WASI shim mapping to <code>@bytecodealliance/preview2-shim</code>.</p>
</li>
<li>
<p><code>--map</code>: Provide custom mappings for world imports. Supports both wildcard mappings (<code>*</code> similarly as in the package.json “exports” field) as well as <code>#</code> mappings for targetting exported interfaces. For example, the WASI mappings are internally defined with mappings like <code>--map wasi:filesystem/*=@bytecodealliance/preview2-shim/filesystem#*</code> to map <code>import as * filesystem from 'wasi:filesystem/types'</code> to <code>import { types } from '@bytecodealliance/preview2-shim/filesystem</code>.</p>
</li>
<li>
<p><code>--no-nodejs-compat</code>: Disables Node.js compat in the output to load core Wasm with FS methods.</p>
</li>
<li>
<p><code>--instantiation [mode]</code>: Instead of a direct ES module, export an <code>instantiate</code> function which can take the imports as an argument instead of implicit imports. The <code>instantiate</code> function can be async (with <code>--instantiation</code> or <code>--instantiation async</code>), or sync (with <code>--instantiation sync</code>).</p>
</li>
<li>
<p><code>--valid-lifting-optimization</code>: Internal validations are removed assuming that core Wasm binaries are valid components, providing a minor output size saving.</p>
</li>
<li>
<p><code>--tracing</code>: Emit tracing calls for all function entry and exits.</p>
</li>
<li>
<p><code>--no-namespaced-exports</code>: Removes exports of the type <code>test as "test:flavorful/test"</code> which are not compatible with typescript</p>
</li>
<li>
<p><code>--async-mode [mode]</code>: EXPERIMENTAL: For the component imports and exports, functions and methods on resources can be specified as <code>async</code>. The only option is <code>jspi</code> (JavaScript Promise Integration).</p>
</li>
<li>
<p><code>--async-imports &lt;imports...&gt;</code>: EXPERIMENTAL: Specify the component imports as <code>async</code>. Used with <code>--async-mode</code>.</p>
</li>
<li>
<p><code>--async-exports &lt;exports...&gt;</code>: EXPERIMENTAL: Specify the component exports as <code>async</code>. Used with <code>--async-mode</code>.</p>
</li>
</ul>
<h2 id="browser-support"><a class="header" href="#browser-support">Browser Support</a></h2>
<p>Jco itself can be used in the browser, which provides the simpler Jco API that is just exactly the same
as the internal <a href="https://github.com/bytecodealliance/jco/blob/main/crates/js-component-bindgen-component/wit/js-component-bindgen.wit">Jco component</a> Jco uses to self-host.</p>
<p>To use this browser-supported internal component build, import the <code>/component</code> subpath directly:</p>
<pre><code class="language-js">import { transpile } from '@bytecodealliance/jco/component';
</code></pre>
<p>Most JS build tools should then correctly work with such code bundled for the browser.</p>
<h3 id="experimental-webidl-imports"><a class="header" href="#experimental-webidl-imports">Experimental WebIDL Imports</a></h3>
<p>Jco has experimental support for zero-runtime and zero-configuration WEbIDL bindings, when using the
<code>webidl:</code> interface.</p>
<p>A canonical WebIDL resource is not yet available, but some examples of these IDLs and WITs can be found
in the <a href="https://github.com/bytecodealliance/jco/tree/main/test/fixtures/idl/">IDL fixtures directory</a>.</p>
<p>Whenever the <code>webidl:</code> namespace is used, Jco will automatically bind such imports to the global object.</p>
<p>Two top-level conventions are then provided for global access:</p>
<ol>
<li>A top-level <code>getWindow</code> function can be used (or for any singleton global name) to obtain the global object.</li>
<li>If the imported interface name starts with <code>global-</code> such as <code>global-console</code>, then the interface is bound
to that object name on the global object, with dashes replaced with <code>.</code> access, ie <code>globalThis.console</code>.</li>
</ol>
<p>Under these conventions, many WebIDL files can be directly supported for components without any additional
runtime configuration needed. A WebIDL to WIT converter is in development at https://github.com/wasi-gfx/webidl2wit.</p>
<p>This work is highly experimental, and contributors and improvements would be welcome to help steer this
feature to stability.</p>
<h2 id="transpilation-semantics"><a class="header" href="#transpilation-semantics">Transpilation Semantics</a></h2>
<h3 id="export-conventions"><a class="header" href="#export-conventions">Export Conventions</a></h3>
<p>Components can represent both bundles of modules and individual modules. Compponents export the direct export interface as well as the canonical named interface for the implementation to represent both of these cases.</p>
<p>For example a component that imports an interface will be output as:</p>
<pre><code class="language-js">export { interface, interface as 'my:pkg/interface@version' }
</code></pre>
<p>The exact version allows for disambiguation when a component exports multiple interfaces with the same name but different versions.</p>
<p>If not needing this disambiguation feature, and since support for string exports in JS can be limited, this feature can be disabled with the <code>--no-namespaced-exports</code> flag to instead output only:</p>
<pre><code class="language-js">export { interface }
</code></pre>
<h3 id="import-conventions"><a class="header" href="#import-conventions">Import Conventions</a></h3>
<p>When using the ESM integration default transpilation output bindings are output directly in the <code>registry:name/interface</code> form, but with versions removed.</p>
<p>For example an import to <code>my:pkg/interface@1.2.3</code> will become an import to <code>import { fn } from 'my:pkg/interface';</code>.</p>
<h3 id="map-configuration"><a class="header" href="#map-configuration">Map Configuration</a></h3>
<p>To customize the import specifiers used in JS, a <code>--map</code> configuration can be provided to the transpilation operation to convert the imports.</p>
<p>For example, <code>jco transpile component.wasm --map my:pkg/interface@1.2.3=./myinterface.js</code> will instead output <code>import { fn } from './myinterface.js'</code>.</p>
<p>Where the file <code>myinterface.js</code> would contain the function that is being imported from the interface:</p>
<pre><code class="language-js">export function fn () {
  // .. function implementation ..
}
</code></pre>
<p>Map configuration also supports <code>#</code> targets, which means that the interface can be read off of a nested JS object export.</p>
<p>For example with a JS file written:</p>
<pre><code class="language-js">export const interface = {
  fn () {
    // exported function to be imported from my:pkg/interface
  }
}
</code></pre>
<p>We can map the interface directly to this object instead of the entire module using the map configuration:</p>
<pre><code>jco transpile component.wasm --map my:pkg/interface@1.2.3=./mypkg.js#interface
</code></pre>
<p>This way a single JS file can define multiple interfaces together.</p>
<p>Furthermore, wildcard mappings are also supported so that using (and quoting for bash compatibility):</p>
<pre><code>jco transpile component.wasm --map 'my:pkg/*@1.2.3=./mypkg.js#*'
</code></pre>
<p>we can map all interfaces into a single JS file reading them off of exported objects for those interfaces.</p>
<h3 id="wasi-shims"><a class="header" href="#wasi-shims">WASI Shims</a></h3>
<p>WASI is given special treatment and is automatically mapped to the <code>@bytecodealliance/preview2-shim</code> npm package, with interfaces imported off of the relevant subsystem.</p>
<p>Using the above rules, this is effectively provided by the default map configuration which is always automatically provided:</p>
<pre><code>jco transpile component.wasm --map wasi:cli/*@0.2.0=@bytecodealliance/preview2-shim/cli#*
</code></pre>
<p>For all subsystems - <code>cli</code>, <code>clocks</code>, <code>filesystem</code>, <code>http</code>, <code>io</code>, <code>random</code> and <code>sockets</code>.</p>
<p>To disable this automatic WASI handling the <code>--no-wasi-shim</code> flag can be provided and WASI will be treated like any other import without special handling.</p>
<p>Note that browser support for WASI is currently experimental.</p>
<h3 id="interface-implementation-example"><a class="header" href="#interface-implementation-example">Interface Implementation Example</a></h3>
<p>Here’s an example of implementing a custom WIT interface in JavaScript:</p>
<p>example.wit</p>
<pre><code class="language-wit">package test:pkg;
interface interface-types {
  type some-type = list&lt;u32&gt;;
  record some-record {
    some-field: some-type
  }
}
interface iface {
  use interface-types.{some-record};
  interface-fn: func(%record: some-record) -&gt; result&lt;string, string&gt;;
}
world myworld {
  import iface;
  export test: func() -&gt; string;
}
</code></pre>
<p>When transpiling, we can use the map rules as described in the previous section to implement all interfaces from a single JS file.</p>
<p>Given a component compiled for this world, we could transpile it, but given this is only an example, we can use the <code>--stub</code> feature of transpile to inspect the bindings:</p>
<pre><code>jco transpile example.wit --stub -o output --map 'test:pkg/*=./imports.js#*'
</code></pre>
<p>The <code>output/example.js</code> file contains the generated bindgen:</p>
<pre><code class="language-js">import { iface } from './imports.js';
const { interfaceFn } = iface;

// ... bindings ...

function test () {
  // ...
}

export { test }
</code></pre>
<p>Therefore, we can implement this mapping of the world with the following JS file:</p>
<p>imports.js</p>
<pre><code class="language-js">export const iface = {
  interfaceFn (record) {
    return 'string';
  }
};
</code></pre>
<blockquote>
<p>Note: Top-level results are turned into JS exceptions, all other results are treated as tagged objects <code>{ tag: 'ok' | 'err', val }</code>.</p>
</blockquote>
<h2 id="wasi-proposals"><a class="header" href="#wasi-proposals">WASI Proposals</a></h2>
<p><strong>Jco will always take PRs to support all open WASI proposals.</strong></p>
<p>These PRs can be implemented by extending the <a href="https://github.com/bytecodealliance/jco/blob/main/src/cmd/transpile.js#L110">default map configuration provided by Jco</a> to support the new <code>--map wasi:subsytem/*=shimpkg/subsystem#*</code> for the WASI subsystem being implemented.</p>
<blockquote>
<p><code>shimpkg</code> in the above refers to a published npm package implementation to install per JS ecosystem conventions. This way, polyfill packages can be published to npm.</p>
</blockquote>
<p>Upstreaming into the <a href="https://github.com/bytecodealliance/jco/tree/main/packages/preview2-shim">@bytecodealliance/preview2-shim</a> package is also possible for WASI proposals that have progressed to Phase 1 in the <a href="https://github.com/WebAssembly/WASI/blob/main/docs/Proposals.md">WASI proposal stage process</a>.</p>
<h2 id="instantiation"><a class="header" href="#instantiation">Instantiation</a></h2>
<p>Instantiation output is enabled via <code>jco transpile component.wasm --instantiation sync|async</code>.</p>
<p>When using instantiation mode, the output is a JS module with a single <code>instantiate()</code> function.</p>
<p>For async instantiation, the instantiate function takes the following signature:</p>
<pre><code class="language-ts">export async function instantiate(
  getCoreModule: (path: string) =&gt; Promise&lt;WebAssembly.Module&gt;,
  imports: {
    [importName: string]: any
  },
  instantiateCore?: (module: WebAssembly.Module, imports: Record&lt;string, any&gt;) =&gt; Promise&lt;WebAssembly.Instance&gt;
): Promise&lt;{ [exportName: string]: any }&gt;;
</code></pre>
<p><code>imports</code> allows customizing the imports provided for instantiation.</p>
<p><code>instantiateCore</code> defaults to <code>WebAssembly.instantiate</code>.</p>
<p><code>getCoreModule</code> can typically be implemented as:</p>
<pre><code class="language-ts">export async function getCoreModule(path: string) {
  return await WebAssembly.compile(await readFile(new URL(`./${path}`, import.meta.url)));
}
</code></pre>
<p>For synchronous instantiation, the instantiate function has the following signature:</p>
<pre><code class="language-ts">export function instantiate(
  getCoreModule: (path: string) =&gt; WebAssembly.Module,
  imports: {
    [importName: string]: any
  },
  instantiateCore?: (module: WebAssembly.Module, imports: Record&lt;string, any&gt;) =&gt; WebAssembly.Instance
): Promise&lt;{ [exportName: string]: any }&gt;;
</code></pre>
<p>Where instead of promises, all functions are synchronous.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="example-workflow"><a href="#example-workflow" class="header">Example Workflow</a></h1>
<h2 id="jco-example-workflow"><a class="header" href="#jco-example-workflow">Jco Example Workflow</a></h2>
<p>Given an existing Wasm Component, <code>jco</code> provides the tooling necessary to work with this Component fully natively in JS.</p>
<p>Jco also provides an experimental feature for generating components from JavaScript by wrapping <a href="https://github.com/bytecodealliance/ComponentizeJS">ComponentizeJS</a> in the <code>jco componentize</code> command.</p>
<p>To demonstrate a full end-to-end component, we can create a JavaScript component embedding Spidermnokey then run it in JavaScript.</p>
<h3 id="installing-jco"><a class="header" href="#installing-jco">Installing Jco</a></h3>
<p>Either install Jco globally:</p>
<pre><code class="language-shell">$ npm install -g @bytecodealliance/jco
$ jco --version
1.0.3
</code></pre>
<p>Or install it locally and use <code>npx</code> to run it:</p>
<pre><code class="language-shell">$ npm install @bytecodealliance/jco
$ npx jco --version
1.0.3
</code></pre>
<p>Local usage can be preferable to ensure the project is reproducible and self-contained, but requires
replacing all <code>jco</code> shell calls in the following example with either <code>./node_modules/.bin/jco</code> or <code>npx jco</code>.</p>
<h3 id="installing-componentizejs"><a class="header" href="#installing-componentizejs">Installing ComponentizeJS</a></h3>
<p>To use ComponentizeJS, it must be separately installed, globally or locally depending on whether Jco was installed globally or locally. Globally:</p>
<pre><code class="language-shell">$ npm install -g @bytecodealliance/componentize-js
</code></pre>
<p>Or locally:</p>
<pre><code class="language-shell">$ npm install @bytecodealliance/componentize-js
</code></pre>
<p>Now the <code>jco componentize</code> command will be ready to use.</p>
<h3 id="creating-a-component-with-componentizejs"><a class="header" href="#creating-a-component-with-componentizejs">Creating a Component with ComponentizeJS</a></h3>
<p>This Cowsay component uses the following WIT file (<a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md">WIT</a> is the typing language used for defining Components):</p>
<p>cowsay.wit</p>
<pre><code class="language-wit">package local:cowsay;
world cowsay {
  export cow: interface {
    enum cows {
      default,
      owl
    }
    say: func(text: string, cow: option&lt;cows&gt;) -&gt; string;
  }
}
</code></pre>
<p>We can implement this with the following JS:</p>
<p>cowsay.js</p>
<pre><code class="language-js">export const cow = {
  say (text, cow = 'default') {
    switch (cow) {
      case 'default':
return `${text}
  \\   ^__^
    \\  (oo)\\______
      (__)\\      )\/\\
          ||----w |
          ||     ||
`;
      case 'owl':
return `${text}
   ___
  (o o)
 (  V  )
/--m-m-
`;
    }
  }
};
</code></pre>
<p>To turn this into a component run:</p>
<pre><code class="language-shell">$ jco componentize cowsay.js --wit cowsay.wit -o cowsay.wasm

OK Successfully written cowsay.wasm with imports ().
</code></pre>
<h3 id="inspecting-component-wit"><a class="header" href="#inspecting-component-wit">Inspecting Component WIT</a></h3>
<p>As a first step, we might like to look instead this binary black box of a Component and see what it actually does.</p>
<pre><code class="language-shell">$ jco wit cowsay.wasm
package root:component;

world root {
  export cow: interface {
    enum cows {
      default,
      owl,
    }

    say: func(text: string, cow: option&lt;cows&gt;) -&gt; string;
  }
}
</code></pre>
<h3 id="transpiling-to-js"><a class="header" href="#transpiling-to-js">Transpiling to JS</a></h3>
<p>To execute the Component in a JS environment, use the <code>jco transpile</code> command to generate the JS for the Component:</p>
<pre><code class="language-shell">$ jco transpile cowsay.wasm -o cowsay

Transpiled JS Component Files:

 - cowsay/cowsay.core.wasm     7.61 MiB
 - cowsay/cowsay.d.ts          0.07 KiB
 - cowsay/cowsay.js            2.62 KiB
 - cowsay/interfaces/cow.d.ts  0.21 KiB
</code></pre>
<p>Now the Component can be directly imported and used as an ES module:</p>
<p>test.js</p>
<pre><code class="language-js">import { cow } from './cowsay/cowsay.js';

console.log(cow.say('Hello Wasm Components!'));
</code></pre>
<p>For Node.js to allow us to run native ES modules, we must first create or edit the local <code>package.json</code> file to include a <code>"type": "module"</code> field:</p>
<p>package.json</p>
<pre><code class="language-json">{
  "type": "module"
}
</code></pre>
<p>The above JavaScript can now be executed in Node.js:</p>
<pre><code class="language-shell">$ node test.js

 Hello Wasm Components!
  \   ^__^
    \  (oo)\______
      (__)\      )/\
          ||----w |
          ||     ||
</code></pre>
<p>Passing in the optional second parameter, we can change the cow:</p>
<p>test.js</p>
<pre><code class="language-js">import { cow } from './cowsay/cowsay.js';

console.log(cow.say('Hello Wasm Components!', 'owl'));
</code></pre>
<pre><code class="language-shell">$ node test.js

 Hello Wasm Components!
   ___
  (o o)
 (  V  )
/--m-m-
</code></pre>
<p>It can also be executed in a browser via a module script:</p>
<pre><code class="language-html">&lt;script type="module" src="test.js"&gt;&lt;/script&gt;
</code></pre>
<p>There are a number of custom transpilation options available, detailed in the <a href="https://github.com/bytecodealliance/jco?tab=readme-ov-file#api">API section</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="host-bindings"><a class="header" href="#host-bindings">Host Bindings</a></h1>
<p>The default mode for host bindings in JS hosts in Jco is through the high-level JS-based bindgen.</p>
<p>The benefit of this approach is that all host bindings are available as normal JS imports. For
example, JavaScript developers can directly import a function like
<code>import { getRandomBytes } from 'wasi:random/random'</code>, and directly interact with the bindings
at a high level.</p>
<p>This also makes it easy to provide custom or virtual implementations for bindings using the same
host semantic conventions.</p>
<p>But for performance-sensitive applications, host bindings still need to have a fast path for
optimized bindgen.</p>
<h2 id="using-native-host-bindings"><a class="header" href="#using-native-host-bindings">Using Native Host Bindings</a></h2>
<p>Given a JS host that implements such a binding, the <code>--import-bindings</code> flag may be used to customize
which host bindings mode to use:</p>
<ul>
<li>The default bindgen mode is <code>--import-bindings=js</code> using high-level JS bindings for all imports.</li>
<li>When generating <code>--import-bindings=hybrid</code>, Jco will still generate the high-level bindgen for all imports, but
check for a <code>Symbol.for('cabiLower')</code> and use this optimized bindgen when available on a function-by-function
basis.</li>
<li>For <code>--import-bindings=optimized</code>, Jco will omit outputting the high-level JS bindgen for imports, and instead use
the low-level bindgen function directly, assuming <code>Symbol.for('cabiLower')</code> is defined on all imports.</li>
<li>For <code>--import-bindings=direct-optimized</code>, instead of reading a <code>Symbol.for('cabiLower')</code>, Jco will assume that
imports are all these lower functions instead (useful in instantiatio mode).</li>
</ul>
<p>This scheme implies instantiation mode to provide the host bindings, or for the host to support
providing the imports as a host ESM import scheme such as <code>import { getRandomBytes } from 'wasi:random/random'</code>.</p>
<h2 id="optimized-host-bindings-spec"><a class="header" href="#optimized-host-bindings-spec">Optimized Host Bindings Spec</a></h2>
<h3 id="fnsymbolforcabilowercanonopts---corefn"><a class="header" href="#fnsymbolforcabilowercanonopts---corefn"><code>fn[Symbol.for('cabiLower')](canonOpts) -&gt; coreFn</code></a></h3>
<p>A function that has a native optimized implementation, can expose its native optimized bindgen through
a <code>Symbol.for('cabiLower')</code> method, taking a <code>canonOpts</code> object.</p>
<p>The following <code>canonOpts</code> fields may be defined as needed:</p>
<ul>
<li><code>memory</code>: The WebAssembly memory object for the component to which we are binding, if needed.</li>
<li><code>realloc</code>: The realloc function inside of the component we are binding, <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Binary.md#canonical-definitions">per component model semantics</a>, if needed.</li>
<li><code>postReturn</code>: The post-return function for the call, if needed.</li>
<li><code>stringEncoding</code>: If needed, with <code>'utf8'</code> as the default.</li>
<li><code>resourceTables</code>: If needed, an ordered list of resource tables in which they uniquely appear in the
function parameters and results of type <code>ResourceTable[]</code>.</li>
</ul>
<p>The return value of this function is then a new function, <code>coreFn</code>, which represents an optimized
native function which can be provided as a direct core function import to the
<code>WebAssembly.instantiate</code> operation of the core binary for the component being linked, providing a
direct host-native binding to the inner core binary of the component without needing an intermediate
lowering operation in the component model semantics.</p>
<h3 id="resourcetable-number"><a class="header" href="#resourcetable-number"><code>ResourceTable: number[]</code></a></h3>
<p>Resource handles are tracked in handle tables, a set of shared slab data structures primarily
relating handles to resource ids (reps) for the particular table. Each resource usually has a unique
handle table assign for every component it is used in.</p>
<p>When handles are passed between component functions, resource state needs to be maintained between
these tables, therefore in optimized bindgen, this shared state needs to be operated on. For example,
resource creation creates an own handle in the table for that resource of the component caller,
requiring the creator to populate a table of the caller.</p>
<p>In optimized bindgen, this is acheived by mutating the data structure accordingly. Great care needs
to be taken to ensure the full component model semantics are followed in this process.</p>
<p>The implementation here is based on a JS array of integers. This is done instead of using typed
arrays because we need resizability without reserving a large buffer like resizable typed arrays
might for the same use case (and unless that changes in future).</p>
<p>The number bits are the lowest 29 bits, while the flag bit for all data values is 1 &lt;&lt; 30. We avoid
the use of the highest bit entirely to not trigger SMI deoptimization.</p>
<p>Each entry consists of a pair of u32s, with each pair either a free list entry, or a data entry.</p>
<h4 id="free-list-entries"><a class="header" href="#free-list-entries">Free List Entries:</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: center">index (x, u30)</th><th style="text-align: center"><del>unused</del></th></tr>
</thead>
<tbody>
<tr><td style="text-align: center">32 bits</td><td style="text-align: center">32 bits</td></tr>
<tr><td style="text-align: center">01xxxxxxxxxxxxxxxxx</td><td style="text-align: center">###################</td></tr>
</tbody>
</table>
</div>
<p>Free list entries use only the first value in the pair, with the high bit always set
to indicate that the pair is part of the free list. The first entry pair at indices
0 and 1 is the free list head, with the initial values of 1 &lt;&lt; 30 and 0 respectively.
Removing the 1 &lt;&lt; 30 flag gives 0, which indicates the end of the free list.</p>
<h4 id="data-entries"><a class="header" href="#data-entries">Data Entries:</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: center">scope (x, u30)</th><th style="text-align: center">own(o), rep(x, u30)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: center">32 bits</td><td style="text-align: center">32 bits</td></tr>
<tr><td style="text-align: center">00xxxxxxxxxxxxxxxxx</td><td style="text-align: center">0oxxxxxxxxxxxxxxxxx</td></tr>
</tbody>
</table>
</div>
<p>Data entry pairs consist of a first u30 scope value and a second rep value. The field
is only called the scope for interface shape consistency, but is actually used for the
ref count for own handles and the scope id for borrow handles. The high bit is never
set for this first entry to distinguish the pair from the free list. The second value
in the pair is the rep for the resource, with the high bit in this entry indicating
if it is an own handle.</p>
<p>The free list numbering and the handle numbering are the same, indexing by pair, so to
get from a handle or free list numbering to an index, we multiply by two.</p>
<p>For example, to access a handle n, we read the pair of values n * 2 and n * 2 + 1 in
the array to get the context and rep respectively. If the high bit is set on the
context, we throw for an invalid handle. The rep value is masked out from the
ownership high bit, also throwing for an invalid zero rep.</p>
<h3 id="resourceinstancesymbolforcabirep"><a class="header" href="#resourceinstancesymbolforcabirep"><code>resourceInstance[Symbol.for('cabiRep')]</code></a></h3>
<p>Normally imported resource classes do not have to define any special symbols, as they are assigned
rep numbers when passed in.</p>
<p>When using hybrid or optimized bindgen, high-level functions may still return and take high-level
resource classes as parameters. For example, a resource type used optimized in import bindgen might
still be constructible elsewhere to be passed in as a parameter to an exported function of a
component attached to that optimized low-level import bindgen.</p>
<p>As a result, when using low-level bindgen, any high-level resource instances MUST define a
<code>Symbol.for('cabiRep')</code> symbol in order for these resources to correctly interact with low-level
bindgen functions referring to those same resources.</p>
<h3 id="resourceclasssymbolforcabidisposerep---void"><a class="header" href="#resourceclasssymbolforcabidisposerep---void"><code>ResourceClass[Symbol.for('cabiDispose')](rep) -&gt; void</code></a></h3>
<p>Just like <code>Symbol.dispose</code> is used in high-level bindgen for imported resources to provide a
destructor for when an own handle to a resource is dropped, low-level bindgen provides this hook
for imported resources through the <code>cabiDispose</code> function.</p>
<p>The <code>Symbol.for('cabiDispose')</code> function is an optional destructor which is available as a direct
static method on the imported resource class.</p>
<p>Unlike the other low-level functions, this one does not need to be bound and is called directly, as
it takes the rep directly to handle internal destructor mechanisms.</p>
<p>Imported resources created externally are always “captured” explicitly when passed in to high-level
functions, even when defining <code>Symbol.for('cabiRep')</code>, so any GC is implicitly averted. In these
capture cases their <code>resourceInstance[Symbol.dispose]()</code> disposal will always be called instead
of <code>cabiDispose</code>, even if they do not define a <code>Symbol.dispose</code>. This allows any custom GC hooks to
apply correctly.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="wit-type-representations"><a class="header" href="#wit-type-representations">WIT Type Representations</a></h1>
<p>Similar to any other guest langauge, there are multiple type systems in play when dealing with JS WebAssembly components.</p>
<p>Types represented in <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md">WebAssembly Interface Types (“WIT”)</a> must be converted down to types that are familiar for Javascript,
and <a href="https://www.typescriptlang.org/">Typescript</a> (if dealing with <code>jco types</code> or <code>jco guest-types</code> subcommands).</p>
<p>This document details the type representations and usage for types that are defined in WIT and built into components.</p>
<h2 id="basic-types"><a class="header" href="#basic-types">Basic types</a></h2>
<p>Here is a basic table of conversions between WIT types and JS types:</p>
<p>More complicated types that are built into WIT but require more work to translate are explained below.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>WIT type</th><th>JS Type</th></tr>
</thead>
<tbody>
<tr><td><code>u8</code></td><td><code>number</code></td></tr>
<tr><td><code>u16</code></td><td><code>number</code></td></tr>
<tr><td><code>u32</code></td><td><code>number</code></td></tr>
<tr><td><code>u64</code></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt"><code>BigInt</code></a></td></tr>
<tr><td><code>s8</code></td><td><code>number</code></td></tr>
<tr><td><code>s16</code></td><td><code>number</code></td></tr>
<tr><td><code>s32</code></td><td><code>number</code></td></tr>
<tr><td><code>s64</code></td><td><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt"><code>BigInt</code></a></td></tr>
<tr><td><code>f32</code></td><td><code>number</code></td></tr>
<tr><td><code>f64</code></td><td><code>number</code></td></tr>
<tr><td><code>bool</code></td><td><code>boolean</code></td></tr>
<tr><td><code>char</code></td><td><code>string</code></td></tr>
<tr><td><code>string</code></td><td><code>string</code></td></tr>
</tbody>
</table>
</div>
<h2 id="variants-variant"><a class="header" href="#variants-variant">Variants (<code>variant</code>)</a></h2>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>See the <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md#item-variant-one-of-a-set-of-types">Variant section of the WIT IDL</a> for more information on Variants</p>
</blockquote>
<p>Variants are like basic enums in most languages with one exception; members of the variant can hold a single data type.
Alternative variant members may hold <em>different</em> types to represent different cases. For example:</p>
<pre><code class="language-wit">variant exit-code {
  success,
  failure-code(u32),
  failure-msg(string),
}
</code></pre>
<h3 id="wit-syntax"><a class="header" href="#wit-syntax">WIT syntax</a></h3>
<pre><code class="language-wit">variant filter {
    all,
    none,
    some(list&lt;string&gt;),
}
</code></pre>
<h3 id="jco-representation"><a class="header" href="#jco-representation">Jco Representation</a></h3>
<p>Jco represents variants as objects with a <code>tag</code> that represents the variant, and <code>val</code> that represents the content:</p>
<p>For example, pseudo Typescript for the of the above <code>filter</code> variant would look like the following:</p>
<pre><code class="language-ts">// Filter with all
{
  tag: 'all';
}

// Filter with None
{
  tag: 'none';
}

// Filter with some and a list of strings
{
  tag: 'some';
  val: string[];
}
</code></pre>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>WIT <code>variant</code>’s options may only contain <em>one</em> piece of data.</p>
<p>You can work around this limitation of variants by having the contained type be a <em>tuple</em>,
(e.g. <code>tuple&lt;string, u32, string&gt;</code>), or using a named record as the related data.</p>
</blockquote>
<h2 id="records-record"><a class="header" href="#records-record">Records (<code>record</code>)</a></h2>
<h3 id="wit-syntax-1"><a class="header" href="#wit-syntax-1">WIT Syntax</a></h3>
<pre><code class="language-wit">record person {
    name: string,
    age: u32,
    favorite-color: option&lt;string&gt;,
}
</code></pre>
<h3 id="jco-representation-1"><a class="header" href="#jco-representation-1">Jco Representation</a></h3>
<p>Jco represents records as the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">Javascript Object basic data type</a>:</p>
<p>Given the WIT record above, you can expect to deal with an object similar to the following Typescript:</p>
<pre><code class="language-ts">interface Person {
  person: string;
  age: number;
  favoriteColor?: number;
}
</code></pre>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>If using <code>jco guest-types</code> or <code>jco types</code>, you will be able to use Typescript types that
properly constrain the Typescript code you write.</p>
</blockquote>
<h2 id="options-option"><a class="header" href="#options-option">Options (<code>option</code>)</a></h2>
<h3 id="wit-syntax-2"><a class="header" href="#wit-syntax-2">WIT Syntax</a></h3>
<pre><code class="language-wit">option&lt;u32, u32&gt;
option&lt;string, u32&gt;
</code></pre>
<h3 id="jco-representation-2"><a class="header" href="#jco-representation-2">Jco Representation</a></h3>
<p>Jco represents options as an optional value or undefined, so some examples:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type</th><th>Representation (TS)</th><th>Example</th></tr>
</thead>
<tbody>
<tr><td><code>option&lt;u32&gt;</code></td><td><code>number | undefined</code></td><td><code>option&lt;u32&gt;</code> -&gt; <code>number | undefined</code></td></tr>
<tr><td><code>option&lt;option&lt;u32&gt;&gt;</code></td><td><code>{ tag: "some" | "none", val: number }</code></td><td><code>option&lt;u32&gt;</code> -&gt; <code>number | undefined</code></td></tr>
</tbody>
</table>
</div>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>“single level” <code>option</code>s are easy to reason about, but the doubly nested case (<code>option&lt;option&lt;_&gt;&gt;</code>) is more complex.</p>
<p>Due to the important distinction between a missing optional versus an <code>option</code> that <em>contains</em> an empty value,
doubly-nested (or more) <code>option</code>s are encoded with the object encoding described above, rather than as an optional value.</p>
</blockquote>
<h3 id="options-in-context-records"><a class="header" href="#options-in-context-records"><code>option</code>s in context: Records</a></h3>
<p>When used in the context of a <code>record</code> (which becomes a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">JS Object</a>), optional values are represented as optional properties (i.e in TS a <code>propName?: value</code>).</p>
<h3 id="options-in-context-function-argumentsreturn-values"><a class="header" href="#options-in-context-function-argumentsreturn-values"><code>option</code>s in context: Function arguments/return values</a></h3>
<p>When used in the context of arguments or return to a function, single level <code>option</code>s are represented as optional values:</p>
<p>Consider the following interface:</p>
<pre><code class="language-wit">interface optional {
    f: func(n: option&lt;u32&gt;) -&gt; string;
}
</code></pre>
<p>An implementation of the function <code>optional.f</code> would look like the following Typescript:</p>
<pre><code class="language-ts">function f(n?: number): string {
  if (n === undefined) { return "no n provided"; }
  return "n was provided";
}
</code></pre>
<h2 id="result-result"><a class="header" href="#result-result">Result (<code>result</code>)</a></h2>
<p><code>Result</code> types, as a general concept represent a result that <em>may or may not</em> be present, due to a failure. A result value either contains
a value that represents a completed computation (<code>SuccessType</code>), or some “error” that indicates a failure (<code>ErrorType</code>).</p>
<p>You can think of the type of a <code>Result</code> as:</p>
<pre><code>Result&lt;SuccessType, ErrorType&gt;
</code></pre>
<p>The value you ultimately deal with is one <em>or</em> the other – either the successful result or the error that represents the failure.</p>
<h3 id="wit-syntax-3"><a class="header" href="#wit-syntax-3">WIT Syntax</a></h3>
<pre><code class="language-wit">result&lt;_, string&gt;
result&lt;, string&gt;
result&lt;t,e&gt;
</code></pre>
<h3 id="jco-representation-3"><a class="header" href="#jco-representation-3">Jco representation</a></h3>
<p>In Javsacript, computation that fails or errors are often represented as exceptions – and depending on how
the <code>result</code> is used, Jco adheres to that representations.</p>
<p>When used as an <em>output</em> to a function, <code>throw</code>ing an error will suffice. Given the following WIT interface:</p>
<pre><code class="language-wit">add-overflow: func(lhs: u32, rhs: u32) -&gt; result&lt;u32, string&gt;;
</code></pre>
<p>The following JS function would satistfy the WIT interface:</p>
<pre><code class="language-js">function addOverflow(lhs, rhs) {
    let sum = lhs + rhs;
    if (Nan.isNan(sum)) {
      throw "ERROR: addition produced non-number value";
    } else if (sum &gt; 4294967295) {
      throw "ERROR: u32 overflow";
    }
    return sum;
}
</code></pre>
<p>While JS automatically converts numbers, we must be careful to not attempt passing a number
that would <em>not</em> fit in a <code>u32</code> (unsigned 32 bit integer) via WebAssembly.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>How JS treats large numbers is not in focus here, but it is worth noting that
<code>Number.MAX_VALUE + Number.MAX_VALUE === Infinity</code>.</p>
</blockquote>
<h3 id="typescript-schema"><a class="header" href="#typescript-schema">Typescript Schema</a></h3>
<pre><code>type Result&lt;T,E&gt; = { tag: 'ok', val: T } | { tag: 'err', val: E };
</code></pre>
<h3 id="results-in-context-function-return-values"><a class="header" href="#results-in-context-function-return-values"><code>result</code>s in context: Function return values</a></h3>
<p>When a result is returned directly from a function, any thrown error of the function is treated as the result error type,
while any direct return value is treated as the result success type.</p>
<p>Consider the following interface:</p>
<pre><code class="language-wit">interface fallible {
    f: func(n: u32) -&gt; result&lt;string, string&gt;;
}
</code></pre>
<p>An implementation of the function <code>fallible.f</code> would look like the following Typescript:</p>
<pre><code class="language-ts">function f(n: number): string {
  if (n == 42) { return "correct"; }
  throw "not correct";
}
</code></pre>
<h3 id="results-in-context-container-types-record-optional-etc"><a class="header" href="#results-in-context-container-types-record-optional-etc"><code>result</code>s in context: Container types (<code>record</code>, <code>optional</code>, etc)</a></h3>
<p>A <code>result</code> stored inside a container type or in non-function argument/return contexts will look like a variant
type of the form <code>{ tag: 'ok', val: SuccessType } | { tag: 'err', val: ErrorType }</code>.</p>
<p>For example, consider the following WIT interface:</p>
<pre><code class="language-wit">interface fallible-reaction {
    r: func(r: result&lt;string, string&gt;) -&gt; string;
}
</code></pre>
<p>An implementation of the function <code>fallible-reaction.r</code> would look like the following Typescript:</p>
<pre><code class="language-ts">type Result&lt;T,E&gt; = { tag: 'ok', val: T } | { tag: 'err', val: E };

function f(input: Result&lt;string, string&gt;): string {
  switch (input.tag) {
    case 'ok': return `SUCCESS, returned: [${input.val}]";
    case 'err': return `ERROR, returned: [${input.val}]";
    // We we should never reach the case below
    default: throw Error("something has gone seriously wrong");
  }
}
</code></pre>
<h3 id="result-considerations-idiomatic-js-errors-for-host-implementations"><a class="header" href="#result-considerations-idiomatic-js-errors-for-host-implementations"><code>result</code> considerations: Idiomatic JS errors for Host implementations</a></h3>
<p>When running a component in a JS host, it is likely for host functions to throw real JS errors (objects which are descendants of the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error"><code>Error</code> global object</a>),
rather than the exact type expected by Jco.</p>
<p>This means that the default conversion mechanism for Jco would be a JS anti-pattern (i.e. <code>throw 12345</code> versus <code>throw new Error("error code 12345")</code>).</p>
<p>To ensure smooth use of Jco-generated code from hosts, <code>Error</code> objects with a <code>payload</code> property will have the payload extracted as the result error type.</p>
<p>Consider the following WIT:</p>
<pre><code class="language-wit">type error-code = u32;

interface only-throws {
    just-throw: func() -&gt; result&lt;string, error-code&gt;;
}
</code></pre>
<p>Consider the following <strong>host</strong> function adhering to the interface, and making use of idiomatic JS errors:</p>
<pre><code class="language-js">// The below code assumes interaction with a WIT which looks like a
function justThrow() {
  const plainError = new Error("Error for JS users");
  const errorWithPayload = Object.assign(plainError, { payload: 1111 });
  throw errorWithPayload;
}
</code></pre>
<h2 id="tuples-tuple"><a class="header" href="#tuples-tuple">Tuples (<code>tuple</code>)</a></h2>
<p>Tuples are a container type that has a fixed size, types somewhat analogous to a fixed size list.</p>
<p>Tuples can be combined with type renaming to produce types that carry some semantic meaning. For example:</p>
<pre><code class="language-wit">type point = tuple&lt;u32,u32&gt;
</code></pre>
<p>Note that <code>tuple</code>s can be combined with custom user-defined types like <code>record</code>s and <code>variants</code>, <code>option</code>s and <code>result</code>s. For example:</p>
<pre><code class="language-wit">variant example-var {
    nothing,
    value(u64),
}

record example-rec {
    fst: string,
    snd: u32,
}

type maybe-num = option&lt;u32&gt;;

type num-or-err-str = result&lt;u32, string&gt;;

type examples = tuple&lt;example-rec, example-var, maybe-num, num-or-err-str&gt;;
</code></pre>
<h3 id="wit-syntax-4"><a class="header" href="#wit-syntax-4">WIT Syntax</a></h3>
<pre><code class="language-wit">tuple&lt;u32, u32&gt;
tuple&lt;string, u32&gt;
</code></pre>
<h3 id="jco-representation-4"><a class="header" href="#jco-representation-4">Jco Representation</a></h3>
<p>Jco represents tuples as lists (arrays), so some examples:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type</th><th>Representation (TS)</th><th>Example</th></tr>
</thead>
<tbody>
<tr><td><code>tuple&lt;u32, u32&gt;</code></td><td><code>[number, number]</code></td><td><code>tuple&lt;u32, u32&gt;</code> -&gt; <code>[number, number]</code></td></tr>
<tr><td><code>tuple&lt;string, u32&gt;</code></td><td><code>[string, number]</code></td><td><code>tuple&lt;string, u32&gt;</code> -&gt; <code>[string, number]</code></td></tr>
</tbody>
</table>
</div>
<h2 id="list-list"><a class="header" href="#list-list">List (<code>list</code>)</a></h2>
<h3 id="wit-syntax-5"><a class="header" href="#wit-syntax-5">WIT Syntax</a></h3>
<pre><code>list&lt;u8&gt;
list&lt;string&gt;
</code></pre>
<h3 id="jco-representation-5"><a class="header" href="#jco-representation-5">Jco Representation</a></h3>
<p>Jco represents lists with native Javscript Arrays, with the exception of a <code>list&lt;u8&gt;</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type</th><th>Representation (TS)</th><th>Example</th></tr>
</thead>
<tbody>
<tr><td><code>list&lt;u8&gt;</code></td><td><code>Uint8Array</code></td><td><code>list&lt;u8&gt;</code> -&gt; <code>Uint8Array</code></td></tr>
<tr><td><code>list&lt;t&gt;</code></td><td><code>T[]</code></td><td><code>list&lt;string&gt;</code> -&gt; <code>string[]</code></td></tr>
</tbody>
</table>
</div>
<h2 id="resources-resource"><a class="header" href="#resources-resource">Resources (<code>resource</code>)</a></h2>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>See the <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md#item-resource">WIT IDL description of Resources</a> for more information</p>
</blockquote>
<p>Resources represent objects that can not be trivially serialized and send copied to another component or the host. Components or host expose resources almost as a reference to internal state that methods can be called on – without providing the actual internals of the resource in question.</p>
<h3 id="wit-syntax-6"><a class="header" href="#wit-syntax-6">WIT Syntax</a></h3>
<pre><code class="language-wit">resource blob {
    constructor(init: list&lt;u8&gt;);
    write: func(bytes: list&lt;u8&gt;);
    read: func(n: u32) -&gt; list&lt;u8&gt;;
    merge: static func(lhs: borrow&lt;blob&gt;, rhs: borrow&lt;blob&gt;) -&gt; blob;
}
</code></pre>
<h3 id="jco-representation-6"><a class="header" href="#jco-representation-6">Jco representation</a></h3>
<p>The example above could be represented with the following class in Typescript pseudo-code:</p>
<pre><code class="language-ts">class Blob {
    constructor(init: Uint8Array);

    write(bytes: Uint8Array);

    read(n: number): UInt8Array;

    static merge(lhs: Uint8Array, rhs: Uint8Array): Blob;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="manual-wasm-instantiation-with-wasi-overrides"><a class="header" href="#manual-wasm-instantiation-with-wasi-overrides">Manual Wasm instantiation with WASI Overrides</a></h1>
<p>When a Wasm component depends on functionality provided by WASI, the <code>jco transpile</code> produces a WebAssembly
module that can be loaded from NodeJS or the Browser that includes usages of unresolved imports like <code>wasi:random/random</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Normally, WASI imports that need to be sourced from elsewhere would be <em>mapped</em>, using the
<code>--map</code> option to <code>jco transpile</code>.</p>
<p>These instructions are for when mapping is insufficient or implementations must be redirected
or changed at instantiation time.</p>
</blockquote>
<p>A common usage of transpilation is to map the imports to a known package, like <a href="https://www.npmjs.com/package/@bytecodealliance/preview2-shim"><code>@bytecodealliance/preview2-shim</code></a>:</p>
<pre><code class="language-console">jco transpile \
    component.wasm \
    --output dist/transpiled \
    --map wasi:cli/*@0.2.0=@bytecodealliance/preview2-shim/cli#*
</code></pre>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>For more information, see the <a href="#map-configuration">Map Configuration section of the Transpiling documentation</a></p>
</blockquote>
<p>Sometimes you may want to use <em>your own</em> implementation of WASI interfaces (whether partial or complete),
known/resolved only at instantiation time.</p>
<h2 id="manual-instantiation-of-a-transpiled-component-with-no-overrides"><a class="header" href="#manual-instantiation-of-a-transpiled-component-with-no-overrides">Manual instantiation of a transpiled component with no overrides</a></h2>
<p>To use custom instantiations, in NodeJS we must build with the <code>async</code> instantiation mode:</p>
<pre><code class="language-console">jco transpile \
    component.wasm \
    --instantiation async \
    --output dist/transpiled
</code></pre>
<p>We can instantiate the WebAssembly component for use with <em>no</em> custom overrides
(i.e. the default WASI implementations provided by <code>preview2-shim</code>):</p>
<pre><code class="language-js">import { WASIShim } from "@bytecodealliance/preview2-shim/instantiation";

async function main() {
    const wasmESModule = await import("path/to/transpiled/component.js");
    const loader = async (path) =&gt; {
      const buf = await readFile(`./dist/transpiled/${path}`);
      return await WebAssembly.compile(buf.buffer);
    };
    const component = wasmESModule.instantiate(loader, new WASIShim().getImportObject());
    // TODO: add code that utilizes the component's exports
}

await main();
</code></pre>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>When dealing with browser environments, the <code>loader</code> function is not necessary, and <code>null</code>/<code>undefined</code> can be used.</p>
</blockquote>
<p>This is identical to mapping all imports to those provided by <a href="https://www.npmjs.com/package/@bytecodealliance/preview2-shim"><code>@bytecodealliance/preview2-shim</code></a>.</p>
<h2 id="manual-instantiation-of-a-transpiled-component-with-custom-overrides"><a class="header" href="#manual-instantiation-of-a-transpiled-component-with-custom-overrides">Manual instantiation of a transpiled component with custom overrides</a></h2>
<p>To use custom component overrides in addition to the WASI imports provided by <code>preview2-shim</code>,
as before build the component with the <code>async</code> instantiation mode:</p>
<pre><code class="language-console">jco transpile \
    component.wasm \
    --instsantiation async \
    --output dist/transpiled \
    --map wasi:cli/*@0.2.0=@bytecodealliance/preview2-shim/cli#*
</code></pre>
<p>Then write an ES Module like the following:</p>
<pre><code class="language-js">import { readFile } from "node:fs/promises";

import { random } from "@bytecodealliance/preview2-shim";
import { WASIShim } from "@bytecodealliance/preview2-shim/instantiation";

async function main() {
  /// Load the ES module generated by `jco transpile`
  const wasmESModule = await import("./dist/transpiled/component.js");

  // Build a customized WASI shim by mizing custom implementations
  // and the provided implementation
  const customShim = new WASIShim({
    random: {
      // For these two interfaces we re-use the default provided shim
      random: random.random,
      "insecure-seed": random.insecureSeed,
      // For insecure, we can supply our own custom implementation
      // (in this case, one that is *VERY* insecure)
      insecure: {
        getInsecureRandomBytes: (len) =&gt; {
          return new Uint8Array(Number(len)).fill(0);
        },
        getInsecureRandomU64: () =&gt; 42n,
      },
    },
  });

  const loader = async (path) =&gt; {
    const buf = await readFile(`./dist/transpiled/${path}`);
    return await WebAssembly.compile(buf.buffer);
  };

  // Instantiate the Wasm component's ES module
  const component = await wasmESModule.instantiate(
    loader,
    customShim.getImportObject(),
  );

  // TODO: add code to utilize the component exports
}

await main();
</code></pre>
<p>Using <code>WASIShim</code>, you can generate your own custom implementations of WASI, making use of
the published shims where necessary.</p>
<h2 id="versioned-imports-with-wasishim"><a class="header" href="#versioned-imports-with-wasishim">Versioned imports with <code>WASIShim</code></a></h2>
<p>You can also use verisons with the import objects produced by <code>WASIShim</code>:</p>
<pre><code class="language-typescript">import { WASIShim } from '@bytecodealliance/preview2-shim/instantiation';
import type {
    VersionedWASIImportObject,
    WASIImportObject,
} from '@bytecodealliance/preview2-shim/instantiation';

const shim = new WASIShim();

const unversioned: WASIImportObject = shim.getImportObject();
// console.log('unversioned', unversioned);
unversioned satisfies WASIImportObject;
unversioned satisfies VersionedWASIImportObject&lt;''&gt;;

const versioned: VersionedWASIImportObject&lt;'0.2.3'&gt; = shim.getImportObject({
    asVersion: '0.2.3',
});
//console.log('versioned', versioned);
versioned satisfies VersionedWASIImportObject&lt;'0.2.3'&gt;;
</code></pre>
<h2 id="sandboxing-with-wasishim"><a class="header" href="#sandboxing-with-wasishim">Sandboxing with <code>WASIShim</code></a></h2>
<p>By default, the <code>preview2-shim</code> provides full access to the host filesystem, environment variables,
and network - matching the default behavior of Node.js libraries. You can use the <code>sandbox</code> option
to restrict what guests can access.</p>
<p>Each <code>WASIShim</code> instance has its own isolated preopens, environment variables, and arguments.
Multiple instances with different configurations will not affect each other:</p>
<h3 id="fully-sandboxed-instance"><a class="header" href="#fully-sandboxed-instance">Fully sandboxed instance</a></h3>
<p>To create a fully sandboxed instance with no filesystem, network, or environment access:</p>
<pre><code class="language-js">import { WASIShim } from "@bytecodealliance/preview2-shim/instantiation";

const sandboxedShim = new WASIShim({
  sandbox: {
    preopens: {},           // No filesystem access
    env: {},                // No environment variables
    args: ['my-program'],   // Custom arguments
    enableNetwork: false,   // Disable network access
  }
});

const component = await wasmESModule.instantiate(
  loader,
  sandboxedShim.getImportObject(),
);
</code></pre>
<h3 id="limited-filesystem-access"><a class="header" href="#limited-filesystem-access">Limited filesystem access</a></h3>
<p>To provide limited filesystem access by mapping virtual paths to host paths:</p>
<pre><code class="language-js">import { WASIShim } from "@bytecodealliance/preview2-shim/instantiation";

const limitedShim = new WASIShim({
  sandbox: {
    preopens: {
      '/data': '/tmp/guest-data',  // Guest sees /data, maps to /tmp/guest-data
      '/config': '/etc/app'        // Guest sees /config, maps to /etc/app
    },
    env: { 'ENV1': '42' },         // Only expose specific env vars
  }
});

const component = await wasmESModule.instantiate(
  loader,
  limitedShim.getImportObject(),
);
</code></pre>
<h3 id="sandbox-options"><a class="header" href="#sandbox-options">Sandbox options</a></h3>
<p>The <code>sandbox</code> configuration object supports the following options:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>preopens</code></td><td><code>Record&lt;string, string&gt;</code></td><td>Full filesystem</td><td>Map of virtual paths to host paths. Use <code>{}</code> for no filesystem access.</td></tr>
<tr><td><code>env</code></td><td><code>Record&lt;string, string&gt;</code></td><td><code>process.env</code></td><td>Environment variables visible to the guest. Use <code>{}</code> for no env access.</td></tr>
<tr><td><code>args</code></td><td><code>string[]</code></td><td><code>process.argv</code></td><td>Command-line arguments visible to the guest.</td></tr>
<tr><td><code>enableNetwork</code></td><td><code>boolean</code></td><td><code>true</code></td><td>Whether to enable network access (sockets, HTTP).</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="common-issues"><a class="header" href="#common-issues">Common issues</a></h1>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="contributing-to-the-codebase"><a class="header" href="#contributing-to-the-codebase">Contributing to the Codebase</a></h1>
<p>Development is based on a standard NodeJS workflow, i.e.:</p>
<pre><code class="language-console">npm install
npm run build
npm run test
</code></pre>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Required prerequisites for building jco include:</p>
<ul>
<li><a href="https://www.rust-lang.org/tools/install">Latest stable Rust</a> with the <code>wasm32-wasi</code> target</li>
<li>Node.js 18+ &amp; npm (https://nodejs.org/en)</li>
</ul>
<h3 id="rust-toolchain"><a class="header" href="#rust-toolchain">Rust Toolchain</a></h3>
<p>The latest Rust stable toolchain can be installed using <a href="https://rustup.rs/">rustup</a>.</p>
<p>Specifically:</p>
<pre><code class="language-shell">rustup toolchain install stable
rustup target add wasm32-wasi
</code></pre>
<p>In case you do not have <code>rustup</code> installed on your system, please follow the installation instructions on the <a href="https://www.rust-lang.org/tools/install">official Rust website</a> based on your operating system</p>
<h2 id="project-structure"><a class="header" href="#project-structure">Project Structure</a></h2>
<p>jco is effectively a monorepo consisting of the following projects:</p>
<ul>
<li><code>crates/js-component-bindgen</code>: Rust crate for creating JS component bindgen, published under https://crates.io/crates/js-component-bindgen.</li>
<li><code>crates/js-component-bindgen-component</code>: Component wrapper crate for the component bindgen. This allows bindgen to be self-hosted in JS.</li>
<li><code>crates/wasm-tools-component</code>: Component wrapper crate for wasm-tools, allowing jco to invoke various Wasm toolchain functionality and also make it available through the jco API.</li>
<li><code>src/api.js</code>: The jco API which can be used as a library dependency on npm. Published as https://npmjs.org/package/@bytecodealliance/jco.</li>
<li><code>src/jco.js</code>: The jco CLI. Published as https://npmjs.org/package/@bytecodealliance/jco.</li>
<li><code>packages/preview2-shim</code>: The WASI Preview2 host implementations for Node.js &amp; browsers. Published as https://www.npmjs.com/package/@bytecodealliance/preview2-shim.</li>
<li><code>packages/preview3-shim</code>: The WASI Preview3 host implementations for Node.js</li>
</ul>
<h3 id="files-that-should-be-checked-in"><a class="header" href="#files-that-should-be-checked-in">Files that should be checked in</a></h3>
<p>The repository is for project related code only – avoid checking in files related to specific platforms or IDEs. One off configuration and/or secrets should of course not be checked in either.</p>
<p>If there is information/configuration that is important for users or developers to see, include them in documentation and/or examples with appropriate context/explanation.</p>
<h2 id="building"><a class="header" href="#building">Building</a></h2>
<p>To build jco, run:</p>
<pre><code>npm install
npm run build
</code></pre>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>There are three test suites in jco:</p>
<ul>
<li><code>npm run test</code>: Project-level transpilation, CLI &amp; API tests.</li>
<li><code>npm run test --workspace packages/preview2-shim</code>: <code>preview2-shim</code> unit tests.</li>
<li><code>npm run test --workspace packages/preview3-shim</code>: <code>preview3-shim</code> unit tests.</li>
<li><code>test/browser.html</code>: Bare-minimum browser validation test.</li>
<li><code>cargo test</code>: Wasmtime preview2 conformance tests (not currently passing).</li>
</ul>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Generally, when running <code>jco</code> tests, you will want to build the project <em>first</em> during a test run,
to ensure the latest version of Rust code (i.e. <code>js-component-bindgen</code> is in use):</p>
<pre><code>cd packages/jco
npm run build &amp;&amp; npm run test api.js
</code></pre>
<p>The command above runs a single test file – the name of the file is relative to <code>packages/jco/test</code>.</p>
</blockquote>
<h3 id="running-tests-without-bundling"><a class="header" href="#running-tests-without-bundling">Running tests without bundling</a></h3>
<p>Tests can be run without bundling via <code>npm run build:dev &amp;&amp; npm run test:dev</code>.</p>
<h3 id="running-specific-tests"><a class="header" href="#running-specific-tests">Running specific tests</a></h3>
<p>JS tests are powered by <a href="https://vitest.dev"><code>vitest</code></a>, and a specific test suite can be run by passing
the filename to <code>npm run test</code>:</p>
<pre><code class="language-console">cd packages/jco
npm run test runtime.js
</code></pre>
<p>For example, to run multiple tests in a given folder:</p>
<pre><code class="language-console">cd packages/jco
npm run test test/p3/*.js
</code></pre>
<h2 id="commits"><a class="header" href="#commits">Commits</a></h2>
<p>Jco and related subprojects use <a href="https://www.conventionalcommits.org/en/v1.0.0/">Conventional Commits</a>.
Using Conventional Commits helps the project maintain consistency in commit messages, and powers release
automation.</p>
<p>CI enforces that commits are structured in a conventional commit style (see <a href="https://github.com/bytecodealliance/jco/blob/main/commitlint.config.mjs"><code>commitlint.config.mjs</code></a>.
Special care must also be taken to ensure PR titles are formatted in a way that matches conventional commits as well,
when performing squash merges.</p>
<p>The following types are valid:</p>
<ul>
<li><code>build</code></li>
<li><code>chore</code></li>
<li><code>ci</code></li>
<li><code>debug</code></li>
<li><code>docs</code></li>
<li><code>feat</code></li>
<li><code>fix</code></li>
<li><code>perf</code></li>
<li><code>refactor</code></li>
<li><code>release</code></li>
<li><code>revert</code></li>
<li><code>style</code></li>
<li><code>test</code></li>
</ul>
<p>The following project scopes are valid:</p>
<ul>
<li><code>jco</code></li>
<li><code>p2-shim</code></li>
<li><code>p3-shim</code></li>
<li><code>bindgen</code></li>
<li><code>transpile</code></li>
</ul>
<p>For changes made to projects in the repository to be included in releases, the appropriate project scope must be applied.</p>
<p>Since changes that should be made to the repo may not always have a project-specific scope, the
following scopes can be used as well:</p>
<ul>
<li><code>deps</code></li>
<li><code>ci</code></li>
<li><code>ops</code></li>
</ul>
<p>Here are a few example commit messages:</p>
<pre><code>chore(jco): update componentize-js dependency to X.X.X
</code></pre>
<pre><code>feat(ci): add commitlint to actions workflows
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="contributing-to-docs"><a href="#contributing-to-docs" class="header">Contributing to Docs</a></h1>
<p><code>jco</code> is a <a href="https://bytecodealliance.org/">Bytecode Alliance</a> project and follows the Bytecode Alliance’s <a href="https://raw.githubusercontent.com/bytecodealliance/jco/main/CODE_OF_CONDUCT.md">Code of Conduct</a> and <a href="https://raw.githubusercontent.com/bytecodealliance/jco/main/ORG_CODE_OF_CONDUCT.md">Organizational Code of Conduct</a>.</p>
<h2 id="using-this-repository"><a class="header" href="#using-this-repository">Using this repository</a></h2>
<p>You can run the website locally using the <a href="https://rust-lang.github.io/mdBook/index.html">mdBook</a> command line tool.</p>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>To use this repository, you need <a href="https://rust-lang.github.io/mdBook/guide/installation.html">mdBook</a> installed on your workstation.</p>
<h2 id="running-the-website-locally"><a class="header" href="#running-the-website-locally">Running the website locally</a></h2>
<p>After installing mdBook, on GitHub, click the <code>Fork</code> button in the upper-right area of the screen to create a copy of the jco repository in your account. This copy is called a fork.</p>
<p>Next, clone it locally by executing the command below.</p>
<pre><code class="language-shell">git clone https://github.com/bytecodealliance/jco/
cd docs
</code></pre>
<p>To build and test the site locally, run:</p>
<pre><code class="language-shell">mdbook serve --open
</code></pre>
<h2 id="submitting-changes"><a class="header" href="#submitting-changes">Submitting Changes</a></h2>
<ul>
<li>Follow the instructions above to <a href="#running-the-website-locally">make changes to your website locally</a>.</li>
<li>When you are ready to submit those changes, go to your fork and create a new pull request to let us know about it.</li>
</ul>
<p>Everyone is welcome to submit a pull request! Once your pull request is created, we’ll try to get to reviewing it or responding to it in at most a few days. As the owner of the pull request, it is your responsibility to modify your pull request to address the feedback that has been provided to you by the reviewer.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
